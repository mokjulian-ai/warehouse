<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>図面解析ツール</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f2f5;
            padding: 24px 16px;
            min-height: 100vh;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 20px;
        }
        h1 span { color: #888; font-weight: 400; font-size: 1rem; margin-left: 8px; }

        /* Upload Zone */
        .upload-zone {
            background: #fff;
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 20px;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4f46e5;
            background: #f5f3ff;
        }
        .upload-zone p { color: #666; margin-bottom: 8px; }
        .upload-zone .hint { color: #aaa; font-size: 0.85rem; }
        .upload-zone .selected { color: #4f46e5; font-weight: 600; margin-top: 12px; }
        .upload-zone input { display: none; }

        /* Analyze button */
        .btn-row { margin-bottom: 20px; }
        .btn {
            padding: 12px 32px;
            background: #4f46e5;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn:hover { background: #4338ca; }
        .btn:disabled { background: #a5a3d9; cursor: not-allowed; }

        /* Loading */
        .loading { display: none; align-items: center; gap: 12px; margin-bottom: 20px; color: #666; }
        .loading.active { display: flex; }
        .spinner {
            width: 24px; height: 24px;
            border: 3px solid #e0e0e0;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Error */
        .error-msg {
            display: none;
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .error-msg.active { display: block; }

        /* Tabs */
        .results { display: none; }
        .results.active { display: block; }
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 0;
            background: #fff;
            border-radius: 12px 12px 0 0;
            overflow-x: auto;
        }
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab-btn:hover { color: #4f46e5; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; font-weight: 600; }
        .tab-panel {
            display: none;
            background: #fff;
            padding: 24px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            min-height: 200px;
        }
        .tab-panel.active { display: block; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        th { background: #f9fafb; font-weight: 600; color: #555; }
        tr:hover td { background: #f9fafb; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge.pass { background: #dcfce7; color: #166534; }
        .badge.warn { background: #fef9c3; color: #854d0e; }
        .badge.fail { background: #fecaca; color: #991b1b; }
        .badge.single { background: #e0e7ff; color: #3730a3; }
        .badge.pitch { background: #fce7f3; color: #9d174d; }
        .badge.repeat { background: #fff7ed; color: #9a3412; }

        /* SVG views */
        .svg-container {
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            overflow: auto;
        }
        .svg-container svg { max-width: 100%; height: auto; }

        /* Quality checks */
        .check-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .check-icon { font-size: 1.2rem; width: 24px; text-align: center; }
        .check-name { font-weight: 600; color: #333; min-width: 200px; }
        .check-msg { color: #666; flex: 1; }
        .check-detail { color: #999; font-size: 0.85rem; }

        /* JSON */
        .json-block {
            background: #1e1e2e;
            color: #a6e3a1;
            padding: 16px;
            border-radius: 8px;
            overflow: auto;
            max-height: 600px;
            font-family: "SF Mono", "Fira Code", monospace;
            font-size: 0.82rem;
            line-height: 1.5;
            white-space: pre;
        }
        .copy-btn {
            padding: 6px 14px;
            background: #374151;
            color: #d1d5db;
            border: none;
            border-radius: 6px;
            font-size: 0.82rem;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .copy-btn:hover { background: #4b5563; }

        /* PDF overlay */
        .pdf-viewer {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        .pdf-viewer img {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .pdf-viewer svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .pdf-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }
        .pdf-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        .pdf-legend-swatch {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid;
        }

        /* Diagnostics summary */
        .diag-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .diag-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
        }
        .diag-card .label { font-size: 0.8rem; color: #888; }
        .diag-card .value { font-size: 1.3rem; font-weight: 700; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>図面解析ツール</h1>

        <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <p>PDFをここにドロップ、またはクリックして選択</p>
            <p class="hint">AutoCAD出力のベクターPDFに対応</p>
            <div class="selected" id="selectedFile" style="display:none"></div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <div class="btn-row">
            <button class="btn" id="analyzeBtn" onclick="analyzeDrawing()" disabled>解析開始</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>図面を解析中...</span>
        </div>

        <div class="error-msg" id="errorMsg"></div>

        <div class="results" id="results">
            <div class="tab-bar" id="tabBar">
                <button class="tab-btn active" onclick="switchTab('pdf')">PDF表示</button>
                <button class="tab-btn" onclick="switchTab('texts')">テキスト一覧</button>
                <button class="tab-btn" onclick="switchTab('grid')">通り芯</button>
                <button class="tab-btn" onclick="switchTab('dims')">寸法</button>
                <button class="tab-btn" onclick="switchTab('heights')">高さ</button>
                <button class="tab-btn" onclick="switchTab('matching')">マッチング</button>
                <button class="tab-btn" onclick="switchTab('structure')">構造モデル</button>
                <button class="tab-btn" onclick="switchTab('quantity')">積算</button>
                <button class="tab-btn" onclick="switchTab('members')">部材リスト</button>
                <button class="tab-btn" onclick="switchTab('quality')">品質チェック</button>
                <button class="tab-btn" onclick="switchTab('json')">JSON</button>
            </div>

            <div class="tab-panel active" id="panel-pdf"></div>
            <div class="tab-panel" id="panel-texts"></div>
            <div class="tab-panel" id="panel-grid"></div>
            <div class="tab-panel" id="panel-dims"></div>
            <div class="tab-panel" id="panel-heights"></div>
            <div class="tab-panel" id="panel-matching"></div>
            <div class="tab-panel" id="panel-structure"></div>
            <div class="tab-panel" id="panel-quantity"></div>
            <div class="tab-panel" id="panel-members"></div>
            <div class="tab-panel" id="panel-quality"></div>
            <div class="tab-panel" id="panel-json"></div>
        </div>

        <!-- Second panel: 小屋伏図 analysis -->
        <div class="results" id="results2" style="margin-top:24px">
            <div class="tab-bar" id="tabBar2">
                <button class="tab-btn active" onclick="switchTab2('koyafuse-view')">小屋伏図 表示</button>
                <button class="tab-btn" onclick="switchTab2('koyafuse-members')">部材検出</button>
            </div>
            <div class="tab-panel active" id="panel-koyafuse-view"></div>
            <div class="tab-panel" id="panel-koyafuse-members"></div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let analysisData = null;

        // --- Upload handling ---
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");

        dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
        dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
        dropZone.addEventListener("drop", e => {
            e.preventDefault();
            dropZone.classList.remove("dragover");
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener("change", () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith(".pdf")) {
                showError("PDFファイルを選択してください。");
                return;
            }
            selectedFile = file;
            const el = document.getElementById("selectedFile");
            el.textContent = file.name + " (" + (file.size / 1024).toFixed(1) + " KB)";
            el.style.display = "block";
            document.getElementById("analyzeBtn").disabled = false;
            hideError();
        }

        // --- Analysis ---
        async function analyzeDrawing() {
            if (!selectedFile) return;

            const btn = document.getElementById("analyzeBtn");
            const loading = document.getElementById("loading");

            btn.disabled = true;
            loading.classList.add("active");
            hideError();
            document.getElementById("results").classList.remove("active");
            document.getElementById("results2").classList.remove("active");

            const form = new FormData();
            form.append("file", selectedFile);

            try {
                const res = await fetch("/api/analyze", { method: "POST", body: form });
                const data = await res.json();

                if (data.error) {
                    showError(data.error + ": " + (data.detail || ""));
                    return;
                }

                analysisData = data;
                renderResults(data);
                document.getElementById("results").classList.add("active");
            } catch (err) {
                showError("リクエスト失敗: " + err.message);
            } finally {
                loading.classList.remove("active");
                btn.disabled = false;
            }
        }

        function showError(msg) {
            const el = document.getElementById("errorMsg");
            el.textContent = msg;
            el.classList.add("active");
        }
        function hideError() { document.getElementById("errorMsg").classList.remove("active"); }

        // --- Tab switching ---
        function switchTab(name) {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
            const tabs = ["pdf", "texts", "grid", "dims", "heights", "matching", "structure", "quantity", "members", "quality", "json"];
            const idx = tabs.indexOf(name);
            if (idx >= 0) {
                document.querySelectorAll(".tab-btn")[idx].classList.add("active");
                document.getElementById("panel-" + name).classList.add("active");
            }
        }

        // --- Tab switching for second panel ---
        function switchTab2(name) {
            document.querySelectorAll("#tabBar2 .tab-btn").forEach(b => b.classList.remove("active"));
            document.querySelectorAll("#results2 .tab-panel").forEach(p => p.classList.remove("active"));
            var tabs2 = ["koyafuse-view", "koyafuse-members"];
            var idx = tabs2.indexOf(name);
            if (idx >= 0) {
                document.querySelectorAll("#tabBar2 .tab-btn")[idx].classList.add("active");
                document.getElementById("panel-" + name).classList.add("active");
            }
        }

        // --- Render results ---
        function renderResults(data) {
            renderPdfTab(data);
            renderTextListTab(data);
            renderGridTab(data);
            renderDimsTab(data);
            renderHeightsTab(data);
            renderMatchingTab(data);
            renderStructureTab(data);
            renderQuantityTab(data);
            renderMemberCatalogTab();
            renderQualityTab(data);
            renderJsonTab(data);

            // Second panel: 小屋伏図
            renderKoyafuseViewTab(data);
            renderKoyafuseMembersTab(data);
            if (data.page_images && data.page_images.length > 1) {
                document.getElementById("results2").classList.add("active");
            }
        }

        // --- PDF Tab ---
        function renderPdfTab(data) {
            const panel = document.getElementById("panel-pdf");
            if (!data.page_image) {
                panel.innerHTML = '<p style="color:#999">PDF画像がありません。</p>';
                return;
            }

            var html = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">PDFページを描画し、検出されたビュー領域（屋根伏図・平面図・立面図・断面図）を色分けで重ね表示します。</p>';

            const views = data.views || [];
            const rot = data.page_rotation || 0;
            const mw = data.page_width;   // mediabox width
            const mh = data.page_height;  // mediabox height

            // Visual dimensions after rotation
            var visW, visH;
            if (rot === 90 || rot === 270) {
                visW = mh; visH = mw;
            } else {
                visW = mw; visH = mh;
            }

            // Transform mediabox bbox → visual coordinates based on rotation
            // Rotation is CW degrees. Visual size: rot 90/270 → (mh × mw), else (mw × mh)
            // rot=270 (90° CCW): (mx,my) → visual (my, mw - mx)
            // rot=90  (90° CW):  (mx,my) → visual (mh - my, mx)
            function toVisual(bbox) {
                var x0 = bbox.x0, y0 = bbox.y0, x1 = bbox.x1, y1 = bbox.y1;
                var vx0, vy0, vx1, vy1;
                if (rot === 270) {
                    vx0 = y0;      vy0 = mw - x1;
                    vx1 = y1;      vy1 = mw - x0;
                } else if (rot === 90) {
                    vx0 = mh - y1; vy0 = x0;
                    vx1 = mh - y0; vy1 = x1;
                } else if (rot === 180) {
                    vx0 = mw - x1; vy0 = mh - y1;
                    vx1 = mw - x0; vy1 = mh - y0;
                } else {
                    vx0 = x0; vy0 = y0; vx1 = x1; vy1 = y1;
                }
                return { x0: vx0, y0: vy0, x1: vx1, y1: vy1 };
            }

            var colors = {
                "\u5c4b\u6839\u4f0f\u56f3": { fill: "#ef4444", name: "屋根伏図" },
                "\u5e73\u9762\u56f3":       { fill: "#3b82f6", name: "平面図" },
                "\u7acb\u9762\u56f3":       { fill: "#22c55e", name: "立面図" },
                "\u65ad\u9762\u56f3":       { fill: "#f59e0b", name: "断面図" },
                "unknown":                  { fill: "#9ca3af", name: "Unknown" }
            };

            // Legend
            html += '<div class="pdf-legend">';
            views.forEach(function(v) {
                var c = colors[v.view_type] || colors["unknown"];
                html += '<div class="pdf-legend-item">';
                html += '<div class="pdf-legend-swatch" style="background:' + c.fill + '33;border-color:' + c.fill + '"></div>';
                html += '<span>' + c.name + (v.scale ? ' (S=' + v.scale + ')' : '') + '</span>';
                html += '</div>';
            });
            html += '</div>';

            // PDF image with SVG overlay
            html += '<div class="pdf-viewer">';
            html += '<img src="data:image/png;base64,' + data.page_image + '" alt="PDF page">';
            html += '<svg viewBox="0 0 ' + visW + ' ' + visH + '" preserveAspectRatio="none">';

            views.forEach(function(v) {
                var c = colors[v.view_type] || colors["unknown"];
                var vr = toVisual(v.region);
                var w = vr.x1 - vr.x0, h = vr.y1 - vr.y0;
                // Rectangle
                html += '<rect x="' + vr.x0 + '" y="' + vr.y0 + '" width="' + w + '" height="' + h + '" ';
                html += 'fill="' + c.fill + '" fill-opacity="0.12" stroke="' + c.fill + '" stroke-width="3" stroke-dasharray="8,4"/>';
                // Label background
                var labelW = 180, labelH = 28;
                html += '<rect x="' + vr.x0 + '" y="' + vr.y0 + '" width="' + labelW + '" height="' + labelH + '" ';
                html += 'fill="' + c.fill + '" rx="4"/>';
                // Label text
                html += '<text x="' + (vr.x0 + 8) + '" y="' + (vr.y0 + 19) + '" fill="#fff" font-size="16" font-weight="bold">';
                html += c.name + (v.scale ? '  S=' + v.scale : '') + '</text>';
                // Corner coordinates
                var corners = [
                    { x: vr.x0, y: vr.y0, anchor: "start",  label: "(" + vr.x0.toFixed(0) + "," + vr.y0.toFixed(0) + ")", dy: -4 },
                    { x: vr.x1, y: vr.y0, anchor: "end",    label: "(" + vr.x1.toFixed(0) + "," + vr.y0.toFixed(0) + ")", dy: -4 },
                    { x: vr.x0, y: vr.y1, anchor: "start",  label: "(" + vr.x0.toFixed(0) + "," + vr.y1.toFixed(0) + ")", dy: 14 },
                    { x: vr.x1, y: vr.y1, anchor: "end",    label: "(" + vr.x1.toFixed(0) + "," + vr.y1.toFixed(0) + ")", dy: 14 }
                ];
                corners.forEach(function(cr) {
                    // dot
                    html += '<circle cx="' + cr.x + '" cy="' + cr.y + '" r="4" fill="' + c.fill + '"/>';
                    // bg for readability
                    html += '<text x="' + cr.x + '" y="' + (cr.y + cr.dy) + '" text-anchor="' + cr.anchor + '" ';
                    html += 'font-size="11" fill="' + c.fill + '" font-weight="bold" ';
                    html += 'stroke="#fff" stroke-width="3" paint-order="stroke">' + cr.label + '</text>';
                });
            });

            html += '</svg></div>';
            panel.innerHTML = html;
        }

        // --- Text List Tab ---
        function renderTextListTab(data) {
            const panel = document.getElementById("panel-texts");
            const views = data.views || [];

            if (views.length === 0) {
                panel.innerHTML = '<p style="color:#999">ビューが検出されませんでした。</p>';
                return;
            }

            var totalTexts = 0;
            views.forEach(function(v) { totalTexts += v.texts.length; });

            let html = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">PDFから抽出した全テキスト要素をビュー別に一覧表示します。フォント・サイズ・座標も確認できます。</p>';
            html += '<p style="margin-bottom:16px">合計: <strong>' + views.length + '</strong> ビュー内に <strong>' + totalTexts + '</strong> テキスト</p>';

            views.forEach(function(v) {
                var texts = v.texts || [];
                html += '<h3 style="margin:20px 0 10px;color:#333;font-size:1rem">';
                html += esc(v.view_type) + (v.title_text ? ' — ' + esc(v.title_text) : '');
                html += ' <span style="color:#999;font-weight:400">(' + texts.length + ' テキスト)</span></h3>';

                if (texts.length === 0) {
                    html += '<p style="color:#999;margin-bottom:16px">このビューにテキストはありません。</p>';
                    return;
                }

                html += '<table><tr><th>#</th><th>テキスト</th><th>フォント</th><th>サイズ</th><th>位置 (x, y)</th></tr>';
                texts.forEach(function(t, i) {
                    html += '<tr>';
                    html += '<td style="color:#999">' + (i + 1) + '</td>';
                    html += '<td>' + esc(t.text) + '</td>';
                    html += '<td style="font-size:0.8rem;color:#666">' + esc(t.font) + '</td>';
                    html += '<td style="font-size:0.8rem;color:#666">' + (t.size > 0 ? t.size.toFixed(1) : '-') + '</td>';
                    html += '<td style="font-size:0.8rem;color:#999">(' + t.center.x.toFixed(0) + ', ' + t.center.y.toFixed(0) + ')</td>';
                    html += '</tr>';
                });
                html += '</table>';
            });

            panel.innerHTML = html;
        }

        // --- Grid Tab ---
        function renderGridTab(data) {
            const panel = document.getElementById("panel-grid");
            const grid = data.grid_system;

            if (!grid) {
                panel.innerHTML = '<p style="color:#999">通り芯が検出されませんでした。</p>';
                return;
            }

            let html = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">図面から検出した通り芯（X軸・Y軸）のラベル、位置、グリッド線の有無を表示します。</p>';
            html += '<p style="margin-bottom:16px">検出元ビュー: <strong>' + esc(grid.source_view) + '</strong></p>';

            const allLabels = [].concat(grid.x_labels || [], grid.y_labels || []);
            html += '<table><tr><th>ラベル</th><th>軸</th><th>インデックス</th><th>位置 (pts)</th><th>線あり</th></tr>';
            allLabels.forEach(function(l) {
                html += '<tr>';
                html += '<td><strong>' + esc(l.label) + '</strong></td>';
                html += '<td>' + l.axis + '</td>';
                html += '<td>' + l.index + '</td>';
                html += '<td>' + l.position.toFixed(1) + '</td>';
                html += '<td>' + (l.line ? '<span class="badge pass">あり</span>' : '<span class="badge warn">なし</span>') + '</td>';
                html += '</tr>';
            });
            html += '</table>';
            panel.innerHTML = html;
        }

        // --- Dimensions Tab ---
        function renderDimsTab(data) {
            const panel = document.getElementById("panel-dims");
            const dims = data.dimensions || [];

            if (dims.length === 0) {
                panel.innerHTML = '<p style="color:#999">寸法が検出されませんでした。</p>';
                return;
            }

            const sorted = dims.slice().sort(function(a, b) { return b.value - a.value; });
            let html = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">図面から抽出した寸法値の一覧です。単一寸法・ピッチ（@）・繰返し（×n）の3種別に分類されます。</p>';
            html += '<p style="margin-bottom:16px">' + dims.length + ' 件の寸法を検出</p>';
            html += '<table><tr><th>値 (mm)</th><th>種別</th><th>回数</th><th>原文</th><th>ビュー</th></tr>';
            sorted.forEach(function(d) {
                html += '<tr>';
                html += '<td><strong>' + d.value + '</strong></td>';
                html += '<td><span class="badge ' + d.dim_type + '">' + d.dim_type + '</span></td>';
                html += '<td>' + (d.repeat_count || '-') + '</td>';
                html += '<td>' + esc(d.raw_text) + '</td>';
                html += '<td>' + (d.source_view || '-') + '</td>';
                html += '</tr>';
            });
            html += '</table>';
            panel.innerHTML = html;
        }

        // --- Heights Tab ---
        function renderHeightsTab(data) {
            const panel = document.getElementById("panel-heights");
            const heights = data.heights || [];

            if (heights.length === 0) {
                panel.innerHTML = '<p style="color:#999">高さパラメータが検出されませんでした。</p>';
                return;
            }

            let html = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">立面図・断面図から検出した高さ情報（軒高・最高高さ・GL・FL等）を表示します。</p>';
            html += '<table><tr><th>種別</th><th>値 (mm)</th><th>原文</th><th>ビュー</th></tr>';
            heights.forEach(function(h) {
                html += '<tr>';
                html += '<td><strong>' + esc(h.height_type) + '</strong></td>';
                html += '<td>' + (h.value !== null ? h.value : '-') + '</td>';
                html += '<td>' + esc(h.raw_text) + '</td>';
                html += '<td>' + (h.source_view || '-') + '</td>';
                html += '</tr>';
            });
            html += '</table>';
            panel.innerHTML = html;
        }

        // --- Matching Tab (Step 2) ---
        function renderMatchingTab(data) {
            const panel = document.getElementById("panel-matching");
            const m = data.matching;

            if (!m) {
                panel.innerHTML = '<p style="color:#999">マッチング結果がありません（通り芯が必要です）。</p>';
                return;
            }

            let html = '';

            html += '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">複数ビュー（平面・立面・断面）の寸法と通り芯を照合し、建物のスパン・桁行長さ・ピッチ・高さ等の主要パラメータを決定します。</p>';

            // Building parameters summary cards
            html += '<h3 style="margin-bottom:12px;color:#333;font-size:1rem">建物パラメータ</h3>';
            html += '<div class="diag-grid">';
            if (m.span != null) html += diagCard("スパン (Y)", m.span.toLocaleString() + " mm");
            if (m.length != null) html += diagCard("桁行長さ (X)", m.length.toLocaleString() + " mm");
            if (m.bay_pitch != null) html += diagCard("ベイピッチ", m.bay_pitch.toLocaleString() + " mm");
            if (m.bay_count != null) html += diagCard("ベイ数", m.bay_count);
            if (m.eave_height != null) html += diagCard("軒高", m.eave_height.toLocaleString() + " mm");
            if (m.max_height != null) html += diagCard("最高高さ", m.max_height.toLocaleString() + " mm");
            html += '</div>';

            // Anchored params detail
            var anchored = m.anchored_params || [];
            if (anchored.length > 0) {
                html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">アンカーパラメータ</h3>';
                html += '<table><tr><th>名称</th><th>値</th><th>始点</th><th>終点</th><th>検出元</th><th>原文</th><th>算出方法</th></tr>';
                anchored.forEach(function(p) {
                    html += '<tr>';
                    html += '<td><strong>' + esc(p.name) + '</strong></td>';
                    html += '<td>' + p.value.toLocaleString() + ' ' + esc(p.unit) + '</td>';
                    html += '<td>' + (p.anchor_from || '-') + '</td>';
                    html += '<td>' + (p.anchor_to || '-') + '</td>';
                    html += '<td>' + (p.source_view || '-') + '</td>';
                    html += '<td>' + esc(p.raw_text || '-') + '</td>';
                    html += '<td>' + (p.computed ? '<span class="badge warn">算出値</span>' : '<span class="badge pass">図面値</span>') + '</td>';
                    html += '</tr>';
                });
                html += '</table>';
            }

            // Per-view grid info
            var vgi = m.view_grid_info || [];
            if (vgi.length > 0) {
                html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">ビュー別通り芯ラベル</h3>';
                html += '<table><tr><th>ビュー</th><th>種別</th><th>面</th><th>X ラベル</th><th>Y ラベル</th></tr>';
                vgi.forEach(function(v) {
                    html += '<tr>';
                    html += '<td>' + esc(v.view_title) + '</td>';
                    html += '<td>' + esc(v.view_type) + '</td>';
                    html += '<td>' + (v.grid_side || '-') + '</td>';
                    html += '<td>' + (v.x_labels.length > 0 ? v.x_labels.join(', ') : '-') + '</td>';
                    html += '<td>' + (v.y_labels.length > 0 ? v.y_labels.join(', ') : '-') + '</td>';
                    html += '</tr>';
                });
                html += '</table>';
            }

            // Frame links
            var links = m.frame_links || [];
            if (links.length > 0) {
                html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">フレームリンク（ビュー間X通り芯）</h3>';
                html += '<table><tr><th>X ラベル</th><th>平面位置 (pts)</th><th>立面での面</th></tr>';
                links.forEach(function(fl) {
                    html += '<tr>';
                    html += '<td><strong>' + esc(fl.x_label) + '</strong></td>';
                    html += '<td>' + (fl.plan_x_position != null ? fl.plan_x_position.toFixed(1) : '-') + '</td>';
                    html += '<td>' + (fl.in_elevation_sides.length > 0 ? fl.in_elevation_sides.join(', ') : '<span style="color:#999">none</span>') + '</td>';
                    html += '</tr>';
                });
                html += '</table>';
            }

            // Consistency checks
            var checks = m.consistency_checks || [];
            if (checks.length > 0) {
                html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">整合性チェック</h3>';
                var icons = { pass: "\u2705", warn: "\u26a0\ufe0f", fail: "\u274c" };
                checks.forEach(function(c) {
                    html += '<div class="check-item">';
                    html += '<span class="check-icon">' + (icons[c.status] || '') + '</span>';
                    html += '<span class="check-name">' + esc(c.name) + '</span>';
                    html += '<span class="check-msg">' + esc(c.message) + '</span>';
                    html += '</div>';
                });
            }

            panel.innerHTML = html;
        }

        // --- Structure Tab ---
        var typeNames = { column: "柱", rafter: "梁（ラフター）", ridge_beam: "棟木", purlin: "母屋" };
        function renderStructureTab(data) {
            const panel = document.getElementById("panel-structure");
            const sm = data.structural_model;

            if (!sm) {
                panel.innerHTML = '<p style="color:#999">構造モデルがありません（マッチング結果が必要です）。</p>';
                return;
            }

            var html = '';

            html += '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">マッチング結果から生成した3D構造ワイヤフレームモデルです。柱・梁・棟木・母屋の部材を座標と長さ付きで表示します。</p>';

            // Envelope summary cards
            html += '<h3 style="margin-bottom:12px;color:#333;font-size:1rem">建物外形</h3>';
            html += '<div class="diag-grid">';
            html += diagCard("桁行長さ (X)", sm.envelope.length.toLocaleString() + " mm");
            html += diagCard("スパン (Y)", sm.envelope.span.toLocaleString() + " mm");
            html += diagCard("軒高", sm.envelope.eave_height.toLocaleString() + " mm");
            html += diagCard("棟高", sm.envelope.ridge_height.toLocaleString() + " mm");
            html += diagCard("フレーム数", sm.frame_count);
            html += diagCard("ベイ数", sm.bay_count);
            html += diagCard("ベイピッチ", sm.bay_pitch.toLocaleString() + " mm");
            html += diagCard("総部材数", sm.members.length);
            html += '</div>';

            // Member summary by type
            html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">部材集計</h3>';
            html += '<table><tr><th>種別</th><th>本数</th><th>単位長さ (mm)</th><th>合計長さ (m)</th></tr>';
            var types = ["column", "rafter", "ridge_beam", "purlin"];
            types.forEach(function(t) {
                var members = sm.members.filter(function(m) { return m.member_type === t; });
                if (members.length === 0) return;
                var totalLen = members.reduce(function(sum, m) { return sum + m.length; }, 0);
                var unitLen = members[0].length;
                html += '<tr>';
                html += '<td><strong>' + (typeNames[t] || t) + '</strong></td>';
                html += '<td>' + members.length + '</td>';
                html += '<td>' + unitLen.toFixed(0) + '</td>';
                html += '<td>' + (totalLen / 1000).toFixed(1) + '</td>';
                html += '</tr>';
            });
            // Total row
            var grandTotal = sm.members.reduce(function(sum, m) { return sum + m.length; }, 0);
            html += '<tr style="border-top:2px solid #333;font-weight:bold;background:#f0f0f0">';
            html += '<td>合計</td>';
            html += '<td>' + sm.members.length + '</td>';
            html += '<td>—</td>';
            html += '<td>' + (grandTotal / 1000).toFixed(1) + '</td>';
            html += '</tr>';
            html += '</table>';

            // Member detail table (first 100)
            html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">部材詳細</h3>';
            var showMembers = sm.members.slice(0, 100);
            html += '<table><tr><th>ラベル</th><th>種別</th><th>始点 (x,y,z)</th><th>終点 (x,y,z)</th><th>長さ (mm)</th><th>フレーム</th></tr>';
            showMembers.forEach(function(m) {
                html += '<tr>';
                html += '<td>' + esc(m.label) + '</td>';
                html += '<td><span class="badge single">' + (typeNames[m.member_type] || m.member_type) + '</span></td>';
                html += '<td>(' + m.start.x.toFixed(0) + ', ' + m.start.y.toFixed(0) + ', ' + m.start.z.toFixed(0) + ')</td>';
                html += '<td>(' + m.end.x.toFixed(0) + ', ' + m.end.y.toFixed(0) + ', ' + m.end.z.toFixed(0) + ')</td>';
                html += '<td>' + m.length.toFixed(0) + '</td>';
                html += '<td>' + (m.frame_index !== null ? m.frame_index : '-') + '</td>';
                html += '</tr>';
            });
            html += '</table>';
            if (sm.members.length > 100) {
                html += '<p style="color:#999;margin-top:8px">' + sm.members.length + ' 部材のうち先頭100件を表示。全件はJSONタブを参照。</p>';
            }

            panel.innerHTML = html;
        }

        // --- Quantity Tab (Step 4) ---
        function renderQuantityTab(data) {
            const panel = document.getElementById("panel-quantity");
            const qt = data.quantity_takeoff;

            if (!qt) {
                panel.innerHTML = '<p style="color:#999">積算データがありません（構造モデルが必要です）。</p>';
                return;
            }

            var html = '';
            html += '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">構造モデルの部材を種別・長さでグループ化し、数量集計表を生成します。断面・重量は部材リスト連携後に表示されます。</p>';

            // Summary cards
            html += '<h3 style="margin-bottom:12px;color:#333;font-size:1rem">積算サマリー</h3>';
            html += '<div class="diag-grid">';
            html += diagCard("グループ数", qt.groups.length);
            html += diagCard("総部材数", qt.total_members);
            html += diagCard("総延長", (qt.total_length / 1000).toFixed(1) + " m");
            html += diagCard("総重量", qt.total_weight != null ? (qt.total_weight / 1000).toFixed(2) + " t" : "—");
            html += '</div>';

            // Group table
            html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">部材グループ別集計</h3>';
            html += '<table><tr><th>種別</th><th>断面</th><th>単位長さ (mm)</th><th>本数</th><th>合計長さ (m)</th><th>重量 (kg)</th></tr>';
            qt.groups.forEach(function(g) {
                html += '<tr>';
                html += '<td><strong>' + (typeNames[g.member_type] || g.member_type) + '</strong></td>';
                html += '<td>' + (g.section || '<span style="color:#ccc">—</span>') + '</td>';
                html += '<td>' + g.unit_length.toFixed(0) + '</td>';
                html += '<td>' + g.count + '</td>';
                html += '<td>' + (g.total_length / 1000).toFixed(1) + '</td>';
                html += '<td>' + (g.total_weight != null ? g.total_weight.toFixed(1) : '<span style="color:#ccc">—</span>') + '</td>';
                html += '</tr>';
            });
            // Total row
            var totalWeight = null;
            qt.groups.forEach(function(g) {
                if (g.total_weight != null) {
                    totalWeight = (totalWeight || 0) + g.total_weight;
                }
            });
            html += '<tr style="border-top:2px solid #333;font-weight:bold;background:#f0f0f0">';
            html += '<td>合計</td>';
            html += '<td></td>';
            html += '<td>—</td>';
            html += '<td>' + qt.total_members + '</td>';
            html += '<td>' + (qt.total_length / 1000).toFixed(1) + '</td>';
            html += '<td>' + (totalWeight != null ? totalWeight.toFixed(1) : '—') + '</td>';
            html += '</tr>';
            html += '</table>';

            // Labels preview per group
            html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">グループ別部材ラベル</h3>';
            qt.groups.forEach(function(g) {
                var labels = g.member_labels || [];
                var preview = labels.slice(0, 8).join(', ');
                if (labels.length > 8) preview += ' ... (他 ' + (labels.length - 8) + '本)';
                html += '<div style="margin-bottom:8px">';
                html += '<strong>' + (typeNames[g.member_type] || g.member_type) + '</strong>';
                html += ' (' + g.unit_length.toFixed(0) + 'mm × ' + g.count + '本)';
                html += '<br><span style="color:#666;font-size:0.85rem">' + esc(preview) + '</span>';
                html += '</div>';
            });

            panel.innerHTML = html;
        }

        // --- Member Catalog Tab ---
        var memberCatalogData = null;
        async function renderMemberCatalogTab() {
            const panel = document.getElementById("panel-members");
            panel.innerHTML = '<p style="color:#666">部材リストを読み込み中...</p>';

            try {
                const res = await fetch("/api/member-catalog");
                memberCatalogData = await res.json();
            } catch (err) {
                panel.innerHTML = '<p style="color:#dc2626">部材リスト取得エラー: ' + err.message + '</p>';
                return;
            }

            const catalog = memberCatalogData;
            var html = '';
            html += '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">';
            html += '図面 MEMBER LIST から断面情報を解析し、単位重量 (kg/m) を算出します。ラチストラス部材は弦材＋斜材の合算重量です。';
            html += '</p>';

            html += '<h3 style="margin-bottom:12px;color:#333;font-size:1rem">図番: ' + esc(catalog.drawing_number) + '</h3>';

            // Main table
            html += '<table>';
            html += '<tr><th>NO.</th><th>名称</th><th>断面</th><th>材質</th><th style="text-align:right">断面積 (mm²)</th><th style="text-align:right">単位重量 (kg/m)</th><th>構成</th></tr>';

            catalog.entries.forEach(function(e) {
                var areaText = '-';
                if (e.sections && e.sections.length > 0) {
                    areaText = e.sections.map(function(s) { return s.area.toFixed(1); }).join(' + ');
                }

                html += '<tr>';
                html += '<td><strong>' + esc(e.number) + '</strong></td>';
                html += '<td>' + esc(e.name) + '</td>';
                html += '<td style="font-size:0.85rem">' + esc(e.section_text) + '</td>';
                html += '<td><span class="badge single">' + esc(e.material) + '</span></td>';
                html += '<td style="text-align:right">' + areaText + '</td>';
                html += '<td style="text-align:right;font-weight:700;color:#4f46e5">' + e.unit_weight.toFixed(3) + '</td>';

                // Composition column
                if (e.truss) {
                    var t = e.truss;
                    html += '<td style="font-size:0.8rem;color:#666">';
                    html += '弦材: ' + t.chord_count + '×' + esc(t.chord.notation) + ' (' + t.chord_weight_per_m.toFixed(3) + ')<br>';
                    html += 'ラチス: ' + esc(t.lattice.notation) + '/cos(' + t.angle_deg.toFixed(0) + '°) (' + t.lattice_weight_per_m.toFixed(3) + ')';
                    html += '</td>';
                } else if (e.sections && e.sections.length > 1) {
                    html += '<td style="font-size:0.8rem;color:#666">';
                    html += e.sections.map(function(s) { return esc(s.notation) + ' (' + s.unit_weight.toFixed(3) + ')'; }).join('<br>');
                    html += '</td>';
                } else if (e.sections && e.sections.length === 1) {
                    html += '<td style="font-size:0.8rem;color:#666">' + esc(e.sections[0].shape) + '</td>';
                } else {
                    html += '<td>-</td>';
                }
                html += '</tr>';
            });
            html += '</table>';

            // Calculation formula reference
            html += '<div style="margin-top:24px;padding:16px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px">';
            html += '<h4 style="margin-bottom:8px;color:#333;font-size:0.9rem">計算式</h4>';
            html += '<div style="font-size:0.85rem;color:#666;line-height:1.8">';
            html += 'Pipe (P-Dφ×t): A = π(D−t)t<br>';
            html += 'Square tube (□-B×H×t): A = 2(B+H−2t)t<br>';
            html += 'Angle (L-a×b×t): A = (a+b−t)t<br>';
            html += 'Round bar (M-d): A = πd²/4<br>';
            html += 'ラチストラス: 弦材重量 + ラチス重量/cos(θ)<br>';
            html += '単位重量 = 断面積 × 7.85×10⁻³ kg/(mm²·m)';
            html += '</div></div>';

            panel.innerHTML = html;
        }

        // --- 小屋伏図 View Tab ---
        function renderKoyafuseViewTab(data) {
            var panel = document.getElementById("panel-koyafuse-view");
            var images = data.page_images || [];

            if (images.length < 2) {
                panel.innerHTML = '<p style="color:#999">小屋伏図ページ（2ページ目）がありません。複数ページのPDFをアップロードしてください。</p>';
                return;
            }

            var html = '';
            html += '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">';
            html += 'PDFの2ページ目（小屋伏図）を表示します。部材番号と引出線から各部材の配置を確認できます。';
            html += '</p>';

            // Page selector if more than 2 pages
            if (images.length > 2) {
                html += '<div style="margin-bottom:16px">';
                html += '<label style="color:#555;font-size:0.9rem;margin-right:8px">ページ選択:</label>';
                html += '<select id="koyafusePageSelect" onchange="updateKoyafuseImage()" style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:0.9rem">';
                for (var i = 1; i < images.length; i++) {
                    html += '<option value="' + i + '"' + (i === 1 ? ' selected' : '') + '>ページ ' + (i + 1) + '</option>';
                }
                html += '</select>';
                html += '</div>';
            }

            html += '<div style="background:#fafafa;border:1px solid #e5e7eb;border-radius:8px;padding:16px;overflow:auto">';
            html += '<img id="koyafuseImg" src="data:image/png;base64,' + images[1] + '" alt="小屋伏図" style="max-width:100%;height:auto;display:block">';
            html += '</div>';

            panel.innerHTML = html;
        }

        function updateKoyafuseImage() {
            var sel = document.getElementById("koyafusePageSelect");
            if (!sel || !analysisData || !analysisData.page_images) return;
            var idx = parseInt(sel.value, 10);
            var img = document.getElementById("koyafuseImg");
            if (img && analysisData.page_images[idx]) {
                img.src = "data:image/png;base64," + analysisData.page_images[idx];
            }
        }

        // --- 小屋伏図 Members Tab ---
        var memberTypeNames = {
            "1": "主架構材", "2": "繋材", "3": "繋材", "4": "繋材",
            "5": "繋材", "6": "繋材", "7": "水平繋材", "8": "隅柱材",
            "9": "束材", "10": "胴繋材", "11": "側面開口梁材", "12": "側面開口柱材"
        };

        function renderKoyafuseMembersTab(data) {
            var panel = document.getElementById("panel-koyafuse-members");
            var kf = data.koyafuse;

            if (!kf) {
                panel.innerHTML = '<p style="color:#999">小屋伏図が検出されませんでした。複数ページのPDFをアップロードしてください。</p>';
                return;
            }

            var members = kf.detected_members || [];
            var html = '';

            html += '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">';
            html += '小屋伏図（ページ ' + (kf.page_index + 1) + '）から引出線を辿って検出した部材ラベルの一覧です。';
            if (kf.scale) html += ' 縮尺: S=' + esc(kf.scale);
            html += '</p>';

            // Summary cards
            html += '<div class="diag-grid">';
            html += diagCard("検出部材数", members.length);
            html += diagCard("縮尺", kf.scale || "—");
            html += diagCard("ページ", kf.page_index + 1);
            // Count unique member numbers
            var uniqueNums = {};
            members.forEach(function(m) { uniqueNums[m.member_number] = true; });
            html += diagCard("部材種別数", Object.keys(uniqueNums).length);
            html += '</div>';

            if (members.length === 0) {
                html += '<p style="color:#999">部材ラベルが検出されませんでした。</p>';
                panel.innerHTML = html;
                return;
            }

            // Members table
            html += '<h3 style="margin:20px 0 12px;color:#333;font-size:1rem">検出部材一覧</h3>';
            html += '<table>';
            html += '<tr><th>NO.</th><th>ラベル</th><th>名称</th><th>矢印数</th><th>ラベル位置</th><th>引出線先端</th></tr>';
            members.forEach(function(m) {
                var name = memberTypeNames[m.member_number] || "—";
                var tips = m.leader_tips || [];
                // Show tip positions as compact list
                var tipText = '';
                if (tips.length > 0) {
                    tipText = tips.map(function(t) {
                        return '(' + t.x.toFixed(0) + ',' + t.y.toFixed(0) + ')';
                    }).join(', ');
                    if (tips.length > 4) {
                        tipText = tips.slice(0, 3).map(function(t) {
                            return '(' + t.x.toFixed(0) + ',' + t.y.toFixed(0) + ')';
                        }).join(', ') + ' ... +' + (tips.length - 3) + '';
                    }
                } else {
                    tipText = '<span style="color:#ccc">—</span>';
                }
                html += '<tr>';
                html += '<td><strong>' + esc(m.member_number) + '</strong></td>';
                html += '<td>' + esc(m.label) + '</td>';
                html += '<td>' + esc(name) + (m.modifier ? ' (' + esc(m.modifier) + ')' : '') + '</td>';
                html += '<td style="text-align:center"><span class="badge single">' + m.tip_count + '</span></td>';
                html += '<td style="font-size:0.85rem;color:#666">(' + m.label_x.toFixed(0) + ', ' + m.label_y.toFixed(0) + ')</td>';
                html += '<td style="font-size:0.85rem;color:#666">' + tipText + '</td>';
                html += '</tr>';
            });
            html += '</table>';

            // Drawing area info
            if (kf.drawing_bbox) {
                var bb = kf.drawing_bbox;
                html += '<div style="margin-top:20px;padding:12px 16px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;font-size:0.85rem;color:#666">';
                html += '描画領域: (' + bb.x0.toFixed(0) + ', ' + bb.y0.toFixed(0) + ') — (' + bb.x1.toFixed(0) + ', ' + bb.y1.toFixed(0) + ')';
                html += '</div>';
            }

            panel.innerHTML = html;
        }

        // --- Quality Tab ---
        function renderQualityTab(data) {
            const panel = document.getElementById("panel-quality");
            const q = data.quality;

            if (!q) {
                panel.innerHTML = '<p style="color:#999">品質データがありません。</p>';
                return;
            }

            const icons = { pass: "\u2705", warn: "\u26a0\ufe0f", fail: "\u274c" };
            let html = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">抽出結果の品質ゲートチェックです。ビュー数・通り芯・寸法・高さの検出状況を判定します。</p>';
            html += '<div style="margin-bottom:20px">総合判定: <span class="badge ' + q.overall + '">' + q.overall.toUpperCase() + '</span></div>';

            (q.checks || []).forEach(function(c) {
                html += '<div class="check-item">';
                html += '<span class="check-icon">' + (icons[c.status] || '') + '</span>';
                html += '<span class="check-name">' + esc(c.name) + '</span>';
                html += '<span class="check-msg">' + esc(c.message) + '</span>';
                if (c.detail) html += '<span class="check-detail">' + esc(c.detail) + '</span>';
                html += '</div>';
            });
            panel.innerHTML = html;
        }

        // --- JSON Tab ---
        function renderJsonTab(data) {
            const panel = document.getElementById("panel-json");
            const json = JSON.stringify(data, null, 2);
            panel.innerHTML = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem">解析結果の全データをJSON形式で表示します。外部ツールへの連携やデバッグに利用できます。</p>'
                + '<button class="copy-btn" onclick="copyJson()">JSONをコピー</button>'
                + '<div class="json-block" id="jsonBlock">' + esc(json) + '</div>';
        }

        function copyJson() {
            const text = JSON.stringify(analysisData, null, 2);
            navigator.clipboard.writeText(text).then(function() {
                const btn = document.querySelector(".copy-btn");
                btn.textContent = "コピーしました";
                setTimeout(function() { btn.textContent = "JSONをコピー"; }, 1500);
            });
        }

        // --- Helpers ---
        function esc(s) {
            if (s === null || s === undefined) return '';
            var d = document.createElement("div");
            d.textContent = String(s);
            return d.innerHTML;
        }
        function diagCard(label, value) {
            return '<div class="diag-card"><div class="label">' + label + '</div><div class="value">' + value + '</div></div>';
        }
    </script>
</body>
</html>
